version: '3.8'

# 生产环境 Docker Compose 配置
# 使用预构建的镜像，通过 GitHub Container Registry 拉取

services:
  redis:
    image: redis:7-alpine
    container_name: embed-redis
    expose:
      - "6379"
    volumes:
      - ${WORK_ROOT}/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: embed-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-embed_service}
      POSTGRES_USER: ${POSTGRES_USER:-embed}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-embed_pass}
    volumes:
      - ${WORK_ROOT}/postgres:/var/lib/postgresql/data
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-embed} -d ${POSTGRES_DB:-embed_service}"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  embed-service:
    image: ghcr.io/azincc/gdstudio-embeded-service:latest
    container_name: embed-service
    ports:
      - "5434:8080"
    environment:
      - REDIS_URL=redis:6379
      - DATABASE_URL=postgres://${POSTGRES_USER:-embed}:${POSTGRES_PASSWORD:-embed_pass}@postgres:5432/${POSTGRES_DB:-embed_service}?sslmode=disable
      - GD_API_BASE=https://music-api.gdstudio.xyz
      - NAVIDROME_BASE_URL=${NAVIDROME_BASE_URL}
      - NAVIDROME_USER=${NAVIDROME_USER}
      - NAVIDROME_PASSWORD=${NAVIDROME_PASSWORD}
      - API_KEY=${API_KEY:-dev-api-key-please-change-in-production}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-3}
      - DOWNLOAD_TIMEOUT=${DOWNLOAD_TIMEOUT:-600s}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - TZ=Asia/Shanghai
    volumes:
      - ${NAVIDROME_MUSIC_DIR}:/music:rw
      - ${WORK_ROOT}/work:/work:rw
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # 可选：asynq 任务队列监控 UI
  asynqmon:
    image: hibiken/asynqmon:latest
    container_name: embed-asynqmon
    ports:
      - "8090:8080"
    environment:
      - REDIS_ADDR=redis:6379
    depends_on:
      - redis
    restart: unless-stopped
